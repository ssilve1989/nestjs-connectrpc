# nestjs-buf-connect

A NestJS custom transport strategy for [ConnectRPC](https://connectrpc.com/), enabling you to build type-safe, schema-driven microservices using Protocol Buffers and the Connect protocol.

## Features

- **Seamless Integration**: Works as a standard NestJS Microservice strategy.
- **Type Safety**: leveraging `@bufbuild/protobuf` and `@connectrpc/connect` for end-to-end type safety.
- **Protocol Support**: Supports HTTP/2 and HTTP/1.1.
- **Streaming**: Full support for unary, client streaming, server streaming, and bidirectional streaming RPCs.
- **Decorators**: Idiomatic NestJS decorators for defining services and methods.

## Installation

```bash
npm install nestjs-buf-connect @connectrpc/connect @connectrpc/connect-node @bufbuild/protobuf
# or
pnpm add nestjs-buf-connect @connectrpc/connect @connectrpc/connect-node @bufbuild/protobuf
# or
yarn add nestjs-buf-connect @connectrpc/connect @connectrpc/connect-node @bufbuild/protobuf
```

## Usage

### 1. Define your Protobuf Service

Define your service in a `.proto` file and generate the TypeScript code using `buf`.

### 2. Implement the Service in NestJS

Use the provided decorators to implement your service.

```typescript
import { Controller } from '@nestjs/common';
import { ConnectService, ConnectMethod } from 'nestjs-buf-connect';
import { ExampleService } from './gen/example/v1/example_pb'; // Generated by buf
import { HelloRequest, HelloResponse } from './gen/example/v1/example_pb';

@Controller()
@ConnectService(ExampleService)
export class ExampleController {
  @ConnectMethod()
  async sayHello(request: HelloRequest): Promise<HelloResponse> {
    return new HelloResponse({
      message: `Hello, ${request.name}!`,
    });
  }
}
```

### 3. Configure the Microservice

In your `main.ts`, use the `ConnectRpcServerStrategy`.

```typescript
import { NestFactory } from '@nestjs/core';
import { MicroserviceOptions } from '@nestjs/microservices';
import { ConnectRpcServerStrategy } from 'nestjs-buf-connect';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.createMicroservice<MicroserviceOptions>(
    AppModule,
    {
      strategy: new ConnectRpcServerStrategy({
        port: 8080,
        protocol: 'http2_insecure', // or 'http2', 'http'
      }),
    },
  );

  await app.listen();
}
bootstrap();
```

## API Reference

### Decorators

- `@ConnectService(ServiceDefinition)`: Marks a controller as an implementation of a Connect service.
- `@ConnectMethod()`: Marks a method as an implementation of a service RPC.
- `@ConnectServerStreaming()`: Explicitly marks a method as server streaming.
- `@ConnectClientStreaming()`: Explicitly marks a method as client streaming.
- `@ConnectBidiStreaming()`: Explicitly marks a method as bidirectional streaming.

### Strategy Options

The `ConnectRpcServerStrategy` accepts the following options:

- `port`: The port to listen on.
- `protocol`: The protocol to use (`http`, `https`, `http2`, `http2_insecure`).
- `serverOptions`: Node.js HTTP/HTTP2 server options.
- `connectRouterOptions`: Options passed to the Connect router.

## License

MIT
